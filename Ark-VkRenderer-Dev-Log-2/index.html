<!DOCTYPE html>
<html lang=en>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="renderer" content="webkit">
  <meta http-equiv="Cache-Control" content="no-transform" />
  <meta http-equiv="Cache-Control" content="no-siteapp" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="format-detection" content="telephone=no,email=no,adress=no">
  <!-- Color theme for statusbar -->
  <meta name="theme-color" content="#000000" />
  <!-- 强制页面在当前窗口以独立页面显示,防止别人在框架里调用页面 -->
  <meta http-equiv="window-target" content="_top" />
  
  
  <title>Ark VkRenderer Dev Log 2 | Proton&#39;s Blog</title>
  <meta name="description" content="The ArkDevice cont.Logical device and queuesAfter selecting a physical device to use we need to set up a logical device to interface with it. The logical device creation process is similar to the inst">
<meta property="og:type" content="article">
<meta property="og:title" content="Ark VkRenderer Dev Log 2">
<meta property="og:url" content="https://proton991.github.io/Ark-VkRenderer-Dev-Log-2/index.html">
<meta property="og:site_name" content="Cxy&#39;s Blog">
<meta property="og:description" content="The ArkDevice cont.Logical device and queuesAfter selecting a physical device to use we need to set up a logical device to interface with it. The logical device creation process is similar to the inst">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2022-07-05T01:03:54.000Z">
<meta property="article:modified_time" content="2022-07-14T03:40:00.585Z">
<meta property="article:author" content="Cui Xinyu">
<meta property="article:tag" content="Renderer">
<meta property="article:tag" content="Vulkan">
<meta name="twitter:card" content="summary">
  <!-- Canonical links -->
  <link rel="canonical" href="https://proton991.github.io/Ark-VkRenderer-Dev-Log-2/index.html">
  
    <link rel="alternate" href="/atom.xml" title="Cxy&#39;s Blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png" type="image/x-icon">
  
  
<link rel="stylesheet" href="/css/style.css">

  
    <link href="//cdn.jsdelivr.net/npm/katex@0.9.0/dist/katex.min.css" rel="stylesheet">
  
  
  
  
<meta name="generator" content="Hexo 5.4.0"></head>


<body class="main-center theme-black# 主题颜色 theme-black theme-blue theme-green theme-purple" itemscope itemtype="http://schema.org/WebPage">
  <header class="header" itemscope itemtype="http://schema.org/WPHeader">
  <div class="slimContent">
    <div class="navbar-header">
      
      
      <div class="profile-block text-center">
        <a id="avatar" href="https://github.com/proton991" target="_blank">
          <img class="img-circle img-rotate" src="/images/minions.jpeg" width="200" height="200">
        </a>
        <h2 id="name" class="hidden-xs hidden-sm">Cui Xinyu</h2>
        <h3 id="title" class="hidden-xs hidden-sm hidden-md">Farmer</h3>
        <small id="location" class="text-muted hidden-xs hidden-sm"><i class="icon icon-map-marker"></i> Shanghai, China</small>
      </div>
      
      <div class="search" id="search-form-wrap">

    <form class="search-form sidebar-form">
        <div class="input-group">
            <input type="text" class="search-form-input form-control" placeholder="Search" />
            <span class="input-group-btn">
                <button type="submit" class="search-form-submit btn btn-flat" onclick="return false;"><i class="icon icon-search"></i></button>
            </span>
        </div>
    </form>
    <div class="ins-search">
  <div class="ins-search-mask"></div>
  <div class="ins-search-container">
    <div class="ins-input-wrapper">
      <input type="text" class="ins-search-input" placeholder="Type something..." x-webkit-speech />
      <button type="button" class="close ins-close ins-selectable" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
    </div>
    <div class="ins-section-wrapper">
      <div class="ins-section-container"></div>
    </div>
  </div>
</div>


</div>
      <button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#main-navbar" aria-controls="main-navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
    </div>
    <nav id="main-navbar" class="collapse navbar-collapse" itemscope itemtype="http://schema.org/SiteNavigationElement" role="navigation">
      <ul class="nav navbar-nav main-nav menu-highlight">
        
        
        <li class="menu-item menu-item-home">
          <a href="/.">
            
            <i class="icon icon-home-fill"></i>
            
            <span class="menu-title">Home</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-archives">
          <a href="/archives">
            
            <i class="icon icon-archives-fill"></i>
            
            <span class="menu-title">Archives</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-categories">
          <a href="/categories">
            
            <i class="icon icon-folder"></i>
            
            <span class="menu-title">Categories</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-tags">
          <a href="/tags">
            
            <i class="icon icon-tags"></i>
            
            <span class="menu-title">Tags</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-repository">
          <a href="/repository">
            
            <i class="icon icon-project"></i>
            
            <span class="menu-title">Repository</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-about">
          <a href="/about">
            
            <i class="icon icon-cup-fill"></i>
            
            <span class="menu-title">About</span>
          </a>
        </li>
        
      </ul>
      
	
    <ul class="social-links">
    	
        <li><a href="https://github.com/proton991" target="_blank" title="Github" data-toggle=tooltip data-placement=top><i class="icon icon-github"></i></a></li>
        
        <li><a href="/atom.xml" target="_blank" title="Rss" data-toggle=tooltip data-placement=top><i class="icon icon-rss"></i></a></li>
        
    </ul>

    </nav>
  </div>
</header>

  
    <aside class="sidebar" itemscope itemtype="http://schema.org/WPSideBar">
  <div class="slimContent">
    
      <div class="widget">
    <h3 class="widget-title">Board</h3>
    <div class="widget-body">
        <div id="board">
            <div class="content">
                <p>Welcome!</p>
            </div>
        </div>
    </div>
</div>

    
      
  <div class="widget">
    <h3 class="widget-title">Categories</h3>
    <div class="widget-body">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Computer-Graphics/">Computer Graphics</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Cpp/">Cpp</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Talk/">Talk</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/computer-graphics/">computer graphics</a><span class="category-list-count">10</span></li></ul>
    </div>
  </div>


    
      
  <div class="widget">
    <h3 class="widget-title">Tags</h3>
    <div class="widget-body">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/OpenGL/" rel="tag">OpenGL</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Renderer/" rel="tag">Renderer</a><span class="tag-list-count">10</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Vulkan/" rel="tag">Vulkan</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/algorithm/" rel="tag">algorithm</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/c/" rel="tag">c++</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/c-STL/" rel="tag">c++ STL</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/computer-graphics/" rel="tag">computer-graphics</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ray-tracing/" rel="tag">ray-tracing</a><span class="tag-list-count">1</span></li></ul>
    </div>
  </div>


    
      
  <div class="widget">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget-body tagcloud">
      <a href="/tags/OpenGL/" style="font-size: 13.33px;">OpenGL</a> <a href="/tags/Renderer/" style="font-size: 14px;">Renderer</a> <a href="/tags/Vulkan/" style="font-size: 13.67px;">Vulkan</a> <a href="/tags/algorithm/" style="font-size: 13px;">algorithm</a> <a href="/tags/c/" style="font-size: 13px;">c++</a> <a href="/tags/c-STL/" style="font-size: 13px;">c++ STL</a> <a href="/tags/computer-graphics/" style="font-size: 13px;">computer-graphics</a> <a href="/tags/ray-tracing/" style="font-size: 13px;">ray-tracing</a>
    </div>
  </div>

    
      
  <div class="widget">
    <h3 class="widget-title">Archive</h3>
    <div class="widget-body">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/07/">July 2022</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/06/">June 2022</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/03/">March 2022</a><span class="archive-list-count">2</span></li></ul>
    </div>
  </div>


    
      
  <div class="widget">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget-body">
      <ul class="recent-post-list list-unstyled no-thumbnail">
        
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/computer-graphics/">computer graphics</a>
              </p>
              <p class="item-title">
                <a href="/Ark-VkRenderer-Dev-Log-6/" class="title">Ark VkRenderer Dev Log 6</a>
              </p>
              <p class="item-date">
                <time datetime="2022-07-05T12:25:40.000Z" itemprop="datePublished">2022-07-05</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/Computer-Graphics/">Computer Graphics</a>
              </p>
              <p class="item-title">
                <a href="/Ark-VkRenderer-Dev-Log-5/" class="title">Ark VkRenderer Dev Log 5</a>
              </p>
              <p class="item-date">
                <time datetime="2022-07-05T09:16:11.000Z" itemprop="datePublished">2022-07-05</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/computer-graphics/">computer graphics</a>
              </p>
              <p class="item-title">
                <a href="/Ark-VkRenderer-Dev-Log-4/" class="title">Ark VkRenderer Dev Log 4</a>
              </p>
              <p class="item-date">
                <time datetime="2022-07-05T06:15:51.000Z" itemprop="datePublished">2022-07-05</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/computer-graphics/">computer graphics</a>
              </p>
              <p class="item-title">
                <a href="/Ark-VkRenderer-Dev-Log-3/" class="title">Ark VkRenderer Dev Log 3</a>
              </p>
              <p class="item-date">
                <time datetime="2022-07-05T02:45:22.000Z" itemprop="datePublished">2022-07-05</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/computer-graphics/">computer graphics</a>
              </p>
              <p class="item-title">
                <a href="/Ark-VkRenderer-Dev-Log-2/" class="title">Ark VkRenderer Dev Log 2</a>
              </p>
              <p class="item-date">
                <time datetime="2022-07-05T01:03:54.000Z" itemprop="datePublished">2022-07-05</time>
              </p>
            </div>
          </li>
          
      </ul>
    </div>
  </div>
  

    
  </div>
</aside>

  
  
<aside class="sidebar sidebar-toc collapse" id="collapseToc" itemscope itemtype="http://schema.org/WPSideBar">
  <div class="slimContent">
    <nav id="toc" class="article-toc">
      <h3 class="toc-title">Catalogue</h3>
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#The-ArkDevice-cont"><span class="toc-number">1.</span> <span class="toc-text">The ArkDevice cont.</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Logical-device-and-queues"><span class="toc-number">1.1.</span> <span class="toc-text">Logical device and queues</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Window-surface-and-presentation-queue"><span class="toc-number">1.2.</span> <span class="toc-text">Window surface and presentation queue</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Command-buffers"><span class="toc-number">1.3.</span> <span class="toc-text">Command buffers</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Command-Pools"><span class="toc-number">1.4.</span> <span class="toc-text">Command Pools</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Command-Buffers"><span class="toc-number">1.5.</span> <span class="toc-text">Command Buffers</span></a></li></ol></li></ol>
    </nav>
  </div>
</aside>

<main class="main" role="main">
  <div class="content">
  <article id="post-Ark-VkRenderer-Dev-Log-2" class="article article-type-post" itemscope itemtype="http://schema.org/BlogPosting">
    
    <div class="article-header">
      
        
  
    <h1 class="article-title" itemprop="name">
      Ark VkRenderer Dev Log 2
    </h1>
  

      
      <div class="article-meta">
        <span class="article-date">
    <i class="icon icon-calendar-check"></i>
	<a href="/Ark-VkRenderer-Dev-Log-2/" class="article-date">
	  <time datetime="2022-07-05T01:03:54.000Z" itemprop="datePublished">2022-07-05</time>
	</a>
</span>
        
  <span class="article-category">
    <i class="icon icon-folder"></i>
    <a class="article-category-link" href="/categories/computer-graphics/">computer graphics</a>
  </span>

        
  <span class="article-tag">
    <i class="icon icon-tags"></i>
	<a class="article-tag-link-link" href="/tags/Renderer/" rel="tag">Renderer</a>, <a class="article-tag-link-link" href="/tags/Vulkan/" rel="tag">Vulkan</a>
  </span>


        

        <span class="post-comment"><i class="icon icon-comment"></i> <a href="/Ark-VkRenderer-Dev-Log-2/#comments" class="article-comment-link">Comments</a></span>
        
      </div>
    </div>
    <div class="article-entry marked-body" itemprop="articleBody">
      
        <h1 id="The-ArkDevice-cont"><a href="#The-ArkDevice-cont" class="headerlink" title="The ArkDevice cont."></a>The <code>ArkDevice</code> cont.</h1><h2 id="Logical-device-and-queues"><a href="#Logical-device-and-queues" class="headerlink" title="Logical device and queues"></a>Logical device and queues</h2><p>After selecting a physical device to use we need to set up a <em>logical device</em> to interface with it. The logical device creation process is similar to the instance creation process and describes the features we want to use. We also need to specify which queues to create now that we’ve queried which queue families are available. </p>
<p>The creation process involves specifying a bunch of details in structs. The first one is <code>VkDeviceQueueCreateInfo</code>. This structure describes the number of queues we want for a single queue family, The<code> QueueFamily</code> is found by <code>FindQueueFamilies</code>, which is shown in last dev log.  Then using a while loop to set each <code>VkDeviceQueueCreateInfo</code> separately.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">float</span> queuePriority = <span class="number">1.0f</span>;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">uint32_t</span> queueFamily : uniqueQueueFamilies)</span><br><span class="line">&#123;</span><br><span class="line">    VkDeviceQueueCreateInfo queueCreateInfo = &#123;&#125;;</span><br><span class="line">    queueCreateInfo.sType = VK_STRUCTURE_TYPE_DEVICE_QUEUE_CREATE_INFO;</span><br><span class="line">    queueCreateInfo.queueFamilyIndex = queueFamily;</span><br><span class="line">    queueCreateInfo.queueCount = <span class="number">1</span>;</span><br><span class="line">    queueCreateInfo.pQueuePriorities = &amp;queuePriority;</span><br><span class="line">    queueCreateInfos.<span class="built_in">push_back</span>(queueCreateInfo);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>We make sure that queue families requirement are satisfied when we pick our physical device, then we attach the queue create  info to the logical device.</p>
<p>Next, we specify used device features:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">VkPhysicalDeviceFeatures deviceFeatures = &#123;&#125;;</span><br><span class="line">deviceFeatures.samplerAnisotropy = VK_TRUE;</span><br></pre></td></tr></table></figure>

<p>Here enabling <code>samplerAnisotropy</code> means enhancing the image quality of textures on surfaces through anisotropic filtering (abbreviated AF).</p>
<p>Finally, we can create our logical device, create a <code>VkDeviceCreateInfo</code> struct and fill in data.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">VkDeviceCreateInfo createInfo = &#123;&#125;;</span><br><span class="line">createInfo.sType = VK_STRUCTURE_TYPE_DEVICE_CREATE_INFO;</span><br><span class="line"></span><br><span class="line">createInfo.queueCreateInfoCount = <span class="keyword">static_cast</span>&lt;<span class="keyword">uint32_t</span>&gt;(queueCreateInfos</span><br><span class="line">                                                        .<span class="built_in">size</span>());</span><br><span class="line">createInfo.pQueueCreateInfos = queueCreateInfos.<span class="built_in">data</span>();</span><br><span class="line"></span><br><span class="line">createInfo.pEnabledFeatures = &amp;deviceFeatures;</span><br><span class="line">createInfo.enabledExtensionCount = <span class="keyword">static_cast</span>&lt;<span class="keyword">uint32_t</span>&gt;(</span><br><span class="line">    deviceExtensions.<span class="built_in">size</span>());</span><br><span class="line">createInfo.ppEnabledExtensionNames = deviceExtensions.<span class="built_in">data</span>();</span><br></pre></td></tr></table></figure>

<p>The last step to specify validation layers in already deprecated, but we still add this for compatibility reasons:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// might not really be necessary anymore because device specific validation layers</span></span><br><span class="line"><span class="comment">// have been deprecated</span></span><br><span class="line"><span class="keyword">if</span> (enableValidationLayers)</span><br><span class="line">&#123;</span><br><span class="line">    createInfo.enabledLayerCount = <span class="keyword">static_cast</span>&lt;<span class="keyword">uint32_t</span>&gt;(</span><br><span class="line">        validationLayers.<span class="built_in">size</span>());</span><br><span class="line">    createInfo.ppEnabledLayerNames = validationLayers.<span class="built_in">data</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">    createInfo.enabledLayerCount = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Now we are ready to create our logical device:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="built_in">vkCreateDevice</span>(m_physicalDevice, &amp;createInfo, <span class="literal">nullptr</span>, &amp;m_device) !=</span><br><span class="line">    VK_SUCCESS)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">throw</span> std::<span class="built_in">runtime_error</span>(<span class="string">&quot;failed to create logical device!&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>There’s one more thing to do. The queues are automatically created along with the logical device, but we don’t have a handle to interface with them yet. Add a a class member to store a handle to the graphics queue:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">vkGetDeviceQueue</span>(m_device, indices.m_graphicsFamily, <span class="number">0</span>, &amp;m_graphicsQueue);</span><br></pre></td></tr></table></figure>

<p>Remember to destroy the device before we exit the program,</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">vkDestroyDevice</span>(device, <span class="literal">nullptr</span>);</span><br></pre></td></tr></table></figure>



<h2 id="Window-surface-and-presentation-queue"><a href="#Window-surface-and-presentation-queue" class="headerlink" title="Window surface and presentation queue"></a>Window surface and presentation queue</h2><p> To establish the connection between Vulkan and the window system to present results to the screen, we need to use the WSI (Window System Integration) extensions.  Here we will use <code>VkSurfaceKHR</code>. We create this surface in our <code>WindowSystem</code>:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">WindowSystem::CreateWindowSurface</span><span class="params">(VkInstance instance,</span></span></span><br><span class="line"><span class="params"><span class="function">                                       VkSurfaceKHR* surface)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">glfwCreateWindowSurface</span>(instance, m_window, <span class="literal">nullptr</span>, surface) !=</span><br><span class="line">        VK_SUCCESS)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">throw</span> std::<span class="built_in">runtime_error</span>(<span class="string">&quot;failed to create window surface!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Next, we need to query for presentation support, modify <code>IsDeviceSuitable</code> to check both graphics queue and presentation queue support, modify <code>FindQueueFamilies</code> to get presentation support using <code>vkGetPhysicalDeviceSurfaceSupportKHR</code>.</p>
<h2 id="Command-buffers"><a href="#Command-buffers" class="headerlink" title="Command buffers"></a>Command buffers</h2><p>There’s still one thing left in our <code>ArkDeivce</code>, the command pool <code>VkCommandPool m_commandPool;</code></p>
<p>Commands in Vulkan, like drawing operations and memory transfers, are not executed directly using function calls. We have to record all of the operations we want to perform in command buffer objects. </p>
<p>The advantage of this is that when we are ready to tell the Vulkan what we want to do, all of the commands are submitted together and Vulkan can more efficiently process the commands since all of them are available together. In addition, this allows command recording to happen in multiple threads if so desired.</p>
<h2 id="Command-Pools"><a href="#Command-Pools" class="headerlink" title="Command Pools"></a>Command Pools</h2><p>We have to create a command pool before we can create command buffers. Command pools manage the memory that is used to store the buffers and command buffers are allocated from them.  Add a member variable in our <code>ArkDevice</code>:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">VkCommandPool m_commandPool;</span><br></pre></td></tr></table></figure>

<p>To create a command pool, we need to set its family index and flags:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ArkDevice::CreateCommandPool</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    QueueFamilyIndices queueFamilyIndices = <span class="built_in">FindPhysicalQueueFamilies</span>();</span><br><span class="line"></span><br><span class="line">    VkCommandPoolCreateInfo poolInfo = &#123;&#125;;</span><br><span class="line">    poolInfo.sType = VK_STRUCTURE_TYPE_COMMAND_POOL_CREATE_INFO;</span><br><span class="line">    poolInfo.queueFamilyIndex = queueFamilyIndices.m_graphicsFamily;</span><br><span class="line">    poolInfo.flags =</span><br><span class="line">        VK_COMMAND_POOL_CREATE_TRANSIENT_BIT |</span><br><span class="line">        VK_COMMAND_POOL_CREATE_RESET_COMMAND_BUFFER_BIT;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">vkCreateCommandPool</span>(m_device, &amp;poolInfo, <span class="literal">nullptr</span>, &amp;m_commandPool) !=</span><br><span class="line">        VK_SUCCESS)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">throw</span> std::<span class="built_in">runtime_error</span>(<span class="string">&quot;failed to create command pool!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>There are two possible flags for command pools:</p>
<ul>
<li><code>VK_COMMAND_POOL_CREATE_TRANSIENT_BIT</code>: Hint that command buffers are rerecorded with new commands very often (may change memory allocation behavior)</li>
<li><code>VK_COMMAND_POOL_CREATE_RESET_COMMAND_BUFFER_BIT</code>: Allow command buffers to be rerecorded individually, without this flag they all have to be reset together</li>
</ul>
<p>We will be recording a command buffer every frame, so we want to be able to reset and rerecord over it. Thus, we need to set the <code>VK_COMMAND_POOL_CREATE_RESET_COMMAND_BUFFER_BIT</code> flag bit for our command pool.</p>
<p>Don’ t forget to destroy it:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">vkDestroyCommandPool</span>(m_device, m_commandPool, <span class="literal">nullptr</span>);</span><br></pre></td></tr></table></figure>



<h2 id="Command-Buffers"><a href="#Command-Buffers" class="headerlink" title="Command Buffers"></a>Command Buffers</h2><p>Command buffers will be handled by <code>ArkRenderer</code> class, as we will record our command every frame.  Creating a command buffer is simple:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ArkRenderer::CreateCommandBuffers</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    m_commandBuffers.<span class="built_in">resize</span>(ArkSwapChain::MAX_FRAMES_IN_FLIGHT);</span><br><span class="line">    VkCommandBufferAllocateInfo allocateInfo&#123;&#125;;</span><br><span class="line">    allocateInfo.sType = VK_STRUCTURE_TYPE_COMMAND_BUFFER_ALLOCATE_INFO;</span><br><span class="line">    allocateInfo.level = VK_COMMAND_BUFFER_LEVEL_PRIMARY;</span><br><span class="line">    allocateInfo.commandPool = m_arkDevice.<span class="built_in">GetCommandPool</span>();</span><br><span class="line">    allocateInfo.commandBufferCount = <span class="keyword">static_cast</span>&lt;<span class="keyword">uint32_t</span>&gt;(m_commandBuffers</span><br><span class="line">                                                            .<span class="built_in">size</span>());</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">vkAllocateCommandBuffers</span>(m_arkDevice.<span class="built_in">Device</span>(), &amp;allocateInfo,</span><br><span class="line">                                 m_commandBuffers.<span class="built_in">data</span>()) != VK_SUCCESS)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">throw</span> std::<span class="built_in">runtime_error</span>(<span class="string">&quot;failed to allocate command buffers!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>So how to record our commands? Buffers are associated with frames, so in our <code>ArkRenderer</code>, we begin recording our commands when we begin our frame and end our recording when we end our frame. The whole process comes in 2 parts in <code>ArkRenderer</code>:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">VkCommandBuffer <span class="title">ArkRenderer::BeginFrame</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">assert</span>(</span><br><span class="line">        !m_isFrameStarted &amp;&amp;</span><br><span class="line">        <span class="string">&quot;Can&#x27;t call BeginFrame() while already in progress&quot;</span>);</span><br><span class="line">    <span class="keyword">auto</span> result = m_arkSwapChain-&gt;<span class="built_in">AcquireNextImage</span>(&amp;m_imageIndex);</span><br><span class="line">    <span class="keyword">if</span> (result == VK_ERROR_OUT_OF_DATE_KHR)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">RecreateSwapChain</span>();</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (result != VK_SUCCESS &amp;&amp; result != VK_SUBOPTIMAL_KHR)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">throw</span> std::<span class="built_in">runtime_error</span>(<span class="string">&quot;failed to acquire swap chain image!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    m_isFrameStarted = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">auto</span> commandBuffer = <span class="built_in">GetCurrentCommandBuffer</span>();</span><br><span class="line">    VkCommandBufferBeginInfo beginInfo&#123;&#125;;</span><br><span class="line">    beginInfo.sType = VK_STRUCTURE_TYPE_COMMAND_BUFFER_BEGIN_INFO;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">vkBeginCommandBuffer</span>(commandBuffer, &amp;beginInfo) !=</span><br><span class="line">        VK_SUCCESS)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">throw</span> std::<span class="built_in">runtime_error</span>(</span><br><span class="line">            <span class="string">&quot;failed to begin recording command buffers!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> commandBuffer;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ArkRenderer::EndFrame</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">assert</span>(</span><br><span class="line">        m_isFrameStarted &amp;&amp;</span><br><span class="line">        <span class="string">&quot;Can&#x27;t call EndFrame() while frame is not in progress&quot;</span>);</span><br><span class="line">    <span class="keyword">auto</span> commandBuffer = <span class="built_in">GetCurrentCommandBuffer</span>();</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">vkEndCommandBuffer</span>(commandBuffer) != VK_SUCCESS)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">throw</span> std::<span class="built_in">runtime_error</span>(<span class="string">&quot;failed to record command buffer!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">auto</span> result = m_arkSwapChain-&gt;<span class="built_in">SubmitCommandBuffers</span>(</span><br><span class="line">        &amp;commandBuffer, &amp;m_imageIndex);</span><br><span class="line">    <span class="keyword">if</span> (result == VK_ERROR_OUT_OF_DATE_KHR || result == VK_SUBOPTIMAL_KHR ||</span><br><span class="line">        m_window.<span class="built_in">WasWindowResized</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        m_window.<span class="built_in">ResetWindowResizedFlag</span>();</span><br><span class="line">        <span class="built_in">RecreateSwapChain</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (result != VK_SUCCESS)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">throw</span> std::<span class="built_in">runtime_error</span>(<span class="string">&quot;failed to represent swap chain image!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    m_isFrameStarted = <span class="literal">false</span>;</span><br><span class="line">    m_frameIndex = (m_frameIndex + <span class="number">1</span>) % ArkSwapChain::MAX_FRAMES_IN_FLIGHT;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Notice there’s something about swap chain, which will be covered in the coming dev logs! </p>

      
    </div>
    <div class="article-footer">
      <blockquote class="mt-2x">
  <ul class="post-copyright list-unstyled">
    
    <li class="post-copyright-link hidden-xs">
      <strong>Link：</strong>
      <a href="https://proton991.github.io/Ark-VkRenderer-Dev-Log-2/" title="Ark VkRenderer Dev Log 2" target="_blank" rel="external">https://proton991.github.io/Ark-VkRenderer-Dev-Log-2/</a>
    </li>
    
<!--     <li class="post-copyright-license">
      <strong>版权声明： </strong> 本博客所有文章除特别声明外，均采用 <a href="http://creativecommons.org/licenses/by/4.0/deed.zh" target="_blank" rel="external">CC BY 4.0 CN协议</a> 许可协议。转载请注明出处！
    </li> -->
  </ul>
</blockquote>


<div class="panel panel-default panel-badger">
  <div class="panel-body">
    <figure class="media">
      <div class="media-left">
        <a href="https://github.com/proton991" target="_blank" class="img-burn thumb-sm visible-lg">
          <img src="/images/minions.jpeg" class="img-rounded w-full" alt="">
        </a>
      </div>
      <div class="media-body">
        <h3 class="media-heading"><a href="https://github.com/proton991" target="_blank"><span class="text-dark">Cui Xinyu</span><small class="ml-1x">Farmer</small></a></h3>
        <div>He is lazy...</div>
      </div>
    </figure>
  </div>
</div>


    </div>
  </article>
  
    

  
</div>

  <nav class="bar bar-footer clearfix" data-stick-bottom>
  <div class="bar-inner">
  
  <ul class="pager pull-left">
    
    <li class="prev">
      <a href="/Ark-VkRenderer-Dev-Log-3/" title="Ark VkRenderer Dev Log 3"><i class="icon icon-angle-left" aria-hidden="true"></i><span>&nbsp;&nbsp;Newer</span></a>
    </li>
    
    
    <li class="next">
      <a href="/Ark-VkRenderer-Dev-Log-1/" title="Ark VkRenderer Dev Log 1"><span>Older&nbsp;&nbsp;</span><i class="icon icon-angle-right" aria-hidden="true"></i></a>
    </li>
    
    
    <li class="toggle-toc">
      <a class="toggle-btn collapsed" data-toggle="collapse" href="#collapseToc" aria-expanded="false" title="Catalogue" role="button">
        <span>[&nbsp;</span><span>Catalogue</span>
        <i class="text-collapsed icon icon-anchor"></i>
        <i class="text-in icon icon-close"></i>
        <span>]</span>
      </a>
    </li>
    
  </ul>
  
  
  
  <div class="bar-right">
    
    <div class="share-component" data-sites="weibo,qq,wechat,facebook,twitter" data-mobile-sites="weibo,qq,qzone"></div>
    
  </div>
  </div>
</nav>
  


</main>

  <footer class="footer" itemscope itemtype="http://schema.org/WPFooter">
	
	
    <ul class="social-links">
    	
        <li><a href="https://github.com/proton991" target="_blank" title="Github" data-toggle=tooltip data-placement=top><i class="icon icon-github"></i></a></li>
        
        <li><a href="/atom.xml" target="_blank" title="Rss" data-toggle=tooltip data-placement=top><i class="icon icon-rss"></i></a></li>
        
    </ul>

    <div class="copyright">
    	
        <div class="publishby">
        	Theme by <a href="https://github.com/cofess" target="_blank"> cofess </a>base on <a href="https://github.com/cofess/hexo-theme-pure" target="_blank">pure</a>.
        </div>
    </div>
</footer>
  <script src="//cdn.jsdelivr.net/npm/jquery@1.12.4/dist/jquery.min.js"></script>
<script>
window.jQuery || document.write('<script src="js/jquery.min.js"><\/script>')
</script>

<script src="/js/plugin.min.js"></script>


<script src="/js/application.js"></script>


    <script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: 'Posts',
            PAGES: 'Pages',
            CATEGORIES: 'Categories',
            TAGS: 'Tags',
            UNTITLED: '(Untitled)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>

<script src="/js/insight.js"></script>






   









</body>
</html>